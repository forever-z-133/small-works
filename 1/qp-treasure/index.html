<!DOCTYPE html>
<html class="mobile">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html" />
    <meta name="viewport" content="width=640,user-scalable=no" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <title>环球港寻宝之旅</title>
    <!--[if lt IE 9]><script>alert('您的浏览器版本过低，请更新本版本浏览器，或更换为诸如谷歌浏览器的现代浏览器')</script><![endif]-->
    <link rel="stylesheet" href="libs/common.css">
    <link rel="stylesheet" href="libs/style.css">
    <style>
        .rotate-info {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: #fff;
            display: -webkit-box;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            flex-direction: column;
            -webkit-box-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="rotate-info hide" id="info">请竖着屏幕浏览本页唷</div>
    <div class="body" id="main">
        <!-- loading 页 -->
        <div class="main-load" id="main-load">
            <div class="load-img"><img src="img/loading.gif"></div>
            <div class="load-text"><span id="load-text">0</span>% 加载中</div>
        </div>
        <!-- 首页 -->
        <div class="page welcome" id="welcome">
            <div class="bg"><img src="img/main-bg.jpg"></div>
            <div class="map">
                <div class="bg"><img src="img/map.png"></div>
                <div class="logo"><img src="img/logo.png"></div>
                <div class="cover boxes">
                    <div class="box box-close box1" data-id="1">小厨师奇遇记<span>B2</span></div>
                    <div class="box box-close box2" data-id="2">优礼快闪店<span>南广场</span></div>
                    <div class="box box-close box3" data-id="3">朗读亭<span>1F</span></div>
                    <div class="box box-close box4" data-id="4">顾家禅室<span>3F</span></div>
                    <div class="box box-close box5" data-id="5">魔幻森林展<span>4F</span></div>
                    <div class="box box-close box6" data-id="6">UncleMall奢侈品展卖<span>4F</span></div>
                </div>
            </div>
            <div class="button-box welcome-btns gap-ml">
                <a href="#" class="btn btn-rule"><span>寻宝规则</span></a>
                <a href="#" class="btn btn-activity"><span>寻宝锦囊</span></a>
                <a href="#" class="btn btn-prize disabled"><span>我的宝藏</span></a>
            </div>
        </div>
        <!-- 音效 -->
        <div class="other">
            <a href="#" class="btn-music">
                <div class="icon-music"></div><div class="music-func"></div>
            </a>
            <audio src="media/bgm.mp3" id="bgm" preload autoplay loop></audio>
            <audio src="media/page.mp3" id="page" preload></audio>
        </div>
        <!-- 规则弹窗 -->
        <div class="modal rule" id="rule">
            <div class="bg modal-bg cancel"></div>
            <div class="modal-box zyh-box">
                <div class="modal-title">寻宝规则</div>
                <div class="scroller">
                    <div class="title">活动时间：</div>
                    <div class="word">2017年9月8日 10:00-19:00</div>
                    <div class="title">活动规则：</div>
                    <ul class="list">
                        <li>游戏共设有6个藏宝点，宝藏藏在其中一个藏宝点的宝箱内</li>
                        <li>用户前往藏宝点，扫描二维码，即可查看此藏宝点是否有宝藏</li>
                        <li>100%可以寻得宝藏</li>
                    </ul>
                    <div class="word copyright">*最终解释权归上海环球港所有</div>
                </div>
                <a href="#" class="btn-close-modal cancel"></a>
            </div>
        </div>
        <!-- 锦囊页 -->
        <div class="modal prompt" id="prompt">
            <div class="bg modal-bg cancel"></div>
            <div class="modal-box zyh-box">
                <div class="modal-title">寻宝锦囊</div>
                <div class="scroller"></div>
                <a href="#" class="btn-close-modal cancel"></a>
            </div>
        </div>
        <!-- 详情 -->
        <div class="modal detail" id="detail">
            <div class="bg modal-bg cancel"></div>
            <div class="modal-box zyh-box">
                <div class="scroller"></div>
                <a href="#" class="btn-close-modal cancel"></a>
            </div>
        </div>
        <!-- 抽奖过渡页 -->
        <div class="modal prize" id="prize">
            <div class="bg modal-bg"></div>
            <div class="banner"><img src="img/big-title.png"></div>
            <div class="modal-box cover prize-box">
                <div class="light"><img src="img/light.png"></div>
                <div class="box"></div>
                <div class="finger"><span></span></div>
            </div>
        </div>
        <!-- 中奖 -->
        <div class="modal good" id="good">
            <div class="bg modal-bg"></div>
            <div class="modal-box cover prize-box">
                <div class="light"><img src="img/light.png"></div>
                <div class="box box-prize"></div>
                <div class="word">恭喜您寻到宝藏</div>
                <a href="#" class="btn cancel btn-prize">去拿宝藏</a>
            </div>
            <!-- <a href="#" class="btn-close-modal cancel"></a> -->
        </div>
        <!-- 未中奖 -->
        <div class="modal bad" id="bad">
            <div class="bg modal-bg"></div>
            <div class="modal-box cover prize-box">
                <div class="light"><img src="img/light.png"></div>
                <div class="box box-open"></div>
                <div class="word">你的宝藏不在这个地方，<br>到下一个藏宝点看看吧！<br>就在<span id="address_next">你心里</span>！快去吧！</div>
                <a href="#" class="btn-close-modal cancel"></a>
            </div>
        </div>
        <!-- 结果页 -->
        <div class="modal result" id="result">
            <div class="bg modal-bg cancel"></div>
            <div class="modal-box zyh-box">
                <div class="modal-title">我的宝藏</div>
                <div class="scroller">
                    <div class="qrcode imgRadio">
                        <img src="data:image/png;base64,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" id="qrcode">
                        <img src="img/exchange.png" class="hide" id="exchange">
                    </div>
                    <div class="title" id="prize-name">奖品名称奖品名称奖品名称奖品名称奖品名称</div>
                    <ul class="list">
                        <li><b>兑奖时间：</b><span id="time">9月8日 10:00-24:00</span></li>
                        <li><b>兑奖方式：</b><span id="address">凭中奖二维码至环球港一楼会员中心兑奖</span></li>
                    </ul>
                </div>
                <a href="#" class="btn-close-modal cancel"></a>
            </div>
        </div>
    </div>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="libs/jquery.min.js"></script>
    <script src="libs/common.js"></script>
    <script>
        var debug = true;
        if (debug) $('<div style="position:absolute;left:0;bottom:0;padding:.2em 1em;background:#fff;font-size:16px">预览版</div>').appendTo('.body');

        // ---------------- 转发数据
        var shareJson = {
            title: '快来环球港寻宝啦！',
            link: 'http://sum.kdcer.com/Event?EventId=52',
            imgUrl: 'http://sum.kdcer.com/qpal-treasure/img/icon.jpg',
            desc: '有些宝藏在梦里，有些宝藏在心里，而还有些就在你身边。',
        }

        // ---------------- 公共方法
        // 关闭弹窗
        $('.modal').on('click', '.cancel', function () {
            $(this).parents('.modal').removeClass('in');
        });
        // 开启音乐
        var audio = {
            bgm: $('#bgm')[0],
            page: $('#page')[0],
        }
        WeChat(shareJson.title, shareJson.desc, shareJson.imgUrl, shareJson.link);
        //WxReady(function () {
        //    audio.bgm && audio.bgm.play();
        //    WxShare(shareJson);
        //}, 'scanQRCode');
        // 音乐开关
        $('body').on('click', '.btn-music', function () {
            var $this = $(this).closest('.btn-music');
            $this.toggleClass('off');
            if ($this.is('.off')) audio.bgm.pause();
            else audio.bgm.play();
        });

        // ---------------- 图片预加载
        var imgs = ['img/loading.gif', 'img/box.png', 'img/exchange.png', 'img/light.png', 'img/logo.png', 'img/main-bg.jpg', 'img/map.png', 'img/modal-bg.png'];
        var $load_text = $('#load-text');
        preloadImage(imgs, function (per) {
            $load_text.text(parseInt(per, 10));
        }, Start);

        // 初始化
        var data = [
          {
              id: 1,
              hasOpen: false,
              hasPrize: false,
              name: '小厨师奇遇记',
              address: 'B2花园厅',
              img: ['img/pics/11.jpg', 'img/pics/22.jpg'],
              desc: '用可爱的小厨师形象，向人们用卡通的形式展现了一道菜如何被它用自己的方式“制造”出来的过程。'
          }, {
              id: 2,
              hasOpen: false,
              hasPrize: false,
              name: '南广场优礼快闪店',
              img: ['img/pics/21.jpg', 'img/pics/12.jpg'],
              address: '一楼南广场',
              desc: '石库门游园主题优礼快闪店。冠生园、老凤祥、永久……一场集情怀与回忆的游园会，环球港等你'
          }, {
              id: 3,
              hasOpen: false,
              hasPrize: false,
              name: '朗读亭',
              img: ['img/pics/31.jpg'],
              address: '环球港正门苹果店门口',
              desc: '普陀唯一朗读亭，来环球港创造属于你的小世界'
          }, {
              id: 4,
              hasOpen: false,
              hasPrize: false,
              name: '顾家禅室',
              img: ['img/pics/41.jpg', 'img/pics/42.jpg'],
              address: '三楼中央大厅',
              desc: '从匆忙的城市生活入手，放下手机，在一平米中静心一分钟，思考下人生的意思，寻找一些小确幸，完成一次断舍离'
          }, {
              id: 5,
              hasOpen: false,
              hasPrize: false,
              name: '魔幻森林展',
              img: ['img/pics/51.jpg'],
              address: '四楼博物馆',
              desc: '魔幻森林光影艺术互动展<img src="img/pics/52.jpg" style="width:130px;margin-top:10px">',
          }, {
              id: 6,
              hasOpen: false,
              hasPrize: false,
              name: 'UncleMall奢侈品展卖',
              img: ['img/pics/61.jpg', 'img/pics/62.jpg'],
              address: '四楼演绎空间',
              desc: '全球奢侈品聚惠，潮流大牌1折起'
          },
        ]

        // ---------------- 首页
        function Start() {
            if (debug) {
                $('#main-load').fadeOut('fast');
                $('#welcome').fadeIn(function () {
                    this.className += ' anim';
                });
                $('.btn-prize').removeClass('disabled');
                // 渲染宝箱
                var _html = '';
                for (var i in data) {
                    Math.random() > 0.5 && $('.box' + data[i].id).addClass('box-open');
                    _html += item(data[i]);
                }
                $('.prompt .scroller').append(_html);
                return false;
            }

            $.post('/Event/JourneyEnter', {
                eventId: 52,
                Type: '1',
            }, function (r) {
                console.log('入口', r);

                // 渲染宝箱
                var _html = '';
                for (var i in data) {
                    for (var j in r.Idlist) {
                        if (r.Idlist[j] - 5820 == data[i].id) {
                            $('.box' + data[i].id).addClass('box-open');
                            data[i].hasOpen = true;
                        }
                    }
                    _html += item(data[i]);
                }
                $('.prompt .scroller').append(_html);

                // 显示画面
                $('#main-load').fadeOut('fast');
                $('#welcome').fadeIn(function () {
                    this.className += ' anim';
                });
                // 已核销
                if (r.Take) {
                    $('#exchange').removeClass('hide');
                }
                // 已中奖
                if (r.BonusState) {
                    setPrize(r.BonusState);
                    $('.btn-prize').removeClass('disabled');
                    $('#prize-name').text(r.Des || '默认奖品');
                    //$('#time').text(convertDateStr(r.Time || ''));
                    //$('#address').text(r.Address || '地址地址地址地址');
                    $('#qrcode').prop('src', r.BonusState || '');

                    $('#result').addClass('in');
                    $('#result .modal-bg').removeClass('cancel');
                    $('#result .btn-close-modal').remove();
                    return;
                }
                // 需要签到
                if (r.Sign && r.State) {
                    getSign(GetQueryString('shareCustomer'));
                }
                // 是否合法
                if (r.ErrorMessage) {
                    tool.alert({
                        title: '系统错误',
                        text: r.ErrorMessage,
                    });
                }
                //if (!r.State) {
                //    $('.btn-scan').addClass('disabled');
                //    tool.alert({
                //        title: '操作错误',
                //        text: '非法访问哟~',
                //    });
                //}
            }).fail(function (err) {
                console.log(err);
                alert('入口接口出了问题');
            });
        }
        $('.welcome .box').on('click', function () {
            var $this = $(this), id = $this.attr('data-id');
            var d = data.filter(function (a) { return a.id == id; });
            if (d.length < 1) { alert('有什么地方出了问题'); return; }
            var _title = '';
            if ($this.is('.box-prize')) {
                _html = '<div class="detail-title">没错，你的宝藏就在这里，<br/>还能挖掘新惊喜！</div>' + item(d[0]) + '<a href="#" class="btn btn-prize cancel">去拿宝藏</a>';
            } else if ($this.is('.box-open')) {
                _html = '<div class="detail-title">虽然没找到宝藏，<br/>但可以开辟一个新世界！</div>' + item(d[0]);
            } else {
                _html = '<div class="detail-title">此宝藏点还没有被探索，<br/>赶快来呀！</div>' + item(d[0]);
            }
            audio.page.play();
            $('#detail').addClass('in').find('.scroller').empty().append(_html);

        });
        $('.btn-rule').on('click', function () {
            audio.page.play();
            $('#rule').addClass('in');
        });
        $('.btn-activity').on('click', function () {
            audio.page.play();
            $('#prompt').addClass('in');
        });
        var first = true;
        $('body').on('click', '.btn-prize', function () {
            audio.page.play();

            if (debug) {
                if (first) {
                    first = false;
                    getSign();
                } else {
                    $('#result').addClass('in');
                }
                return;
            }

            $('#result').addClass('in');
        });
        $('.btn-scan').on('click', function () {
            if (typeof wx == 'undefined' && !app.isWX) {
                alert('无法使用微信扫一扫'); return;
            }
            wx.scanQRCode({
                needResult: 1,
                success: function (res) {
                    var result = res.resultStr;
                    getSign(GetQueryString('shareCustomer', result));
                },
                error: function (err) {
                    console.log(err)
                }
            });
        });
        // ---------------- 签到
        function getSign(sign) {
            tool.showToast({
                text: '签到...',
            });

            if (debug) {
                tool.hideToast();
                getPrize();
                return;
            }

            $.post('/Event/JourneySign', {
                eventId: 52,
                Sign: sign,
            }, function (r) {
                console.log('签到', r);
                tool.hideToast();
                if (r.State) {
                    getPrize();
                    tool.showTips({
                        text: '签到成功',
                    });
                } else if (r.ErrorMessage) {
                    tool.alert({
                        title: '签到失败',
                        text: r.ErrorMessage,
                    });
                } else {
                    tool.alert({
                        title: '未知错误',
                        text: JSON.stringify(r),
                    });
                }
                if (!r.ObjectId) return;
                for (var i in data) {
                    if (data[i].id == r.ObjectId.Id - 5820) {
                        $('.box' + data[i].id).addClass('box-open');
                        data[i].hasOpen = true;
                    }
                }
            }).fail(function (err) {
                console.log(err);
                tool.hideToast();
                alert('签到接口出了问题');
            });
        }
        // ---------------- 抽奖
        var thisPrize = null, prizeTimer = null;
        function getPrize(Sign) {
            $('#prize').addClass('in');

            if (debug) {
                thisPrize = 'has';
                prizeTimer = setTimeout(function () {
                    thisPrize = null;
                    $('#prize').removeClass('in');
                    Good();
                }, 7000);
                return;
            }

            $.post('/Event/TreasureLotteryBehavior', {
                eventId: 52,
            }, function (r) {
                console.log('抽奖', r);
                thisPrize = r;
                prizeTimer = setTimeout(function () {
                    thisPrize = null;
                    $('#prize').removeClass('in');
                    if (r.State) {
                        Good();
                        setPrize(r.Bonuses[0]);
                        $('.btn-prize').removeClass('disabled');
                    } else if (r.ErrorMessage) {
                        Bad();
                    } else {
                        tool.alert({
                            title: '未知错误',
                            text: JSON.stringify(r),
                        });
                    }
                }, 7000);
            }).fail(function (err) {
                console.log(err);
                $('#prize').removeClass('in');
                alert('抽奖接口出了问题')
            });
        }
        $('#prize .box').on('click', function () {
            if (thisPrize) {
                var r = thisPrize;
                clearTimeout(prizeTimer);
                $('#prize').removeClass('in');

                if (debug) {
                    Good();
                    thisPrize = null;
                    return;
                }

                if (r.State) {
                    Good();
                    setPrize(r.Bonuses[0]);
                    $('.btn-prize').removeClass('disabled');
                } else if (r.ErrorMessage) {
                    Bad();
                } else {
                    tool.alert({
                        title: '未知错误',
                        text: JSON.stringify(r),
                    });
                }
                thisPrize = null;
            } else {
                alert('恐怕哪出了问题，刷新下试试');
            }
        });

        // ---------------- 中奖未中奖
        function Good() {
            $('#good').addClass('in');
        }

        function Bad() {
            $('#bad').addClass('in');
        }

        function setPrize(bonus) {
            $('#prize-name').text(bonus.Name || '默认奖品');
            //$('#time').text(convertDateStr(bonus.EndDate));
            $('#qrcode').prop('src', bonus.QRCode);
        }

        function item(data) {
            var _html = '';
            _html += '<div class="item">';
            _html += '<div class="image">';
            for (var i in data.img) _html += '<img src="' + data.img[i] + '">';
            _html += '</div>';
            _html += '<div class="content">';
            _html += '<div class="title">' + data.name + '</div>';
            _html += '<div class="address text">' + data.address + '</div>';
            _html += '<div class="word">' + data.desc + '</div>';
            _html += '</div>';
            _html += '</div>';
            return _html;
        }
    </script>
</body>
</html>