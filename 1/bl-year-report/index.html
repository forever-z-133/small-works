<!DOCTYPE html>
<html class="mobile h5">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <title>2017，一起（17）莱！</title>
  <!--[if lt IE 9]><script>alert('您的浏览器版本过低，请更新本版本浏览器，或更换为诸如谷歌浏览器的现代浏览器')</script><![endif]-->
  <link rel="stylesheet" href="libs/style.css">
  <style>
    @media (min-width: 992px) {
      .body {
        width: 750px;
        height: 1334px;
        font-size: 2em;
        overflow: hidden;
        box-shadow: 0 0 1em rgba(0,0,0,.2);
        -webkit-transform: scale(.5);
                transform: scale(.5);
      }
    }
  </style>
</head>

<body>
  <div class="rotate-info" id="info">请保持竖屏浏览</div>
  <div class="body" id="main">
    <div class="notice hide" id="notice">我的天啦</div>
    <div class="main-load hide" id="rendering"><span>贺卡生成中...</span></div>
    <main class="main">
      <div class="main-load" id="main-load">
        <div class="loading-img"><img src="img/loading.gif"></div>
        <div class="loading-text"><span id="load-text">0</span>% 加载中</div>
      </div>
      <div class="page welcome" id="welcome">
        <div class="bg"><img src="img/welcome-bg.jpg"></div>
        <div class="title"><img src="img/main-title.png"></div>
        <div class="qingqing hide"><img src="img/qingqing.png"></div>
        <div class="aolai hide"><img src="img/aolai.png"></div>
      </div>
      <div class="page word" id="word">
        <div class="bg"><img src="img/word-bg.jpg"></div>
        <ul class="word-box list">
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
          <li class="word-item"></li>
        </ul>
        <div class="word2"><img src="img/word2.png"></div>
      </div>
      <div class="page choose" id="choose">
        <div class="bg"><img src="img/choose-bg.jpg"></div>
        <ul class="choose-list list">
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
          <li class="choose-item"></li>
        </ul>
        <div class="choose-what"></div>
        <a href="#" class="btn btn-confirm"><img src="img/btn-confirm.png"></a>
      </div>
      <div class="page result" id="result">
        <div class="bg"><img src="img/result-bg.jpg"></div>
        <div class="user">
          <div class="user-image imgRadio rect"><img src="img/head-image.jpg" id="user-image"></div>
          <div class="user-name" id="user-name">百联青浦奥特莱斯</div>
          <div class="mark imgRadio rect">
            <div class="bg"><img src="img/mark.png"></div>
            <span class="choose-text" id="choose-text">全</span>
          </div>
        </div>
        <ul class="congratulate list" id="congratulate"></ul>
      </div>
      <div class="page" id="share">
        <div class="bg"><img src="" id="share-bg" class="hide"></div>
        <!-- <div class="btn-share"><img src="img/btn-share.png"></div> -->
      </div>
      <div class="others hide">
        <audio src="img/bgm.mp3" id="bgm" preload autoplay loop></audio>
      </div>
    </main>
  </div>
  <script src="libs/common.js"></script>
  <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
  <script src="http://cdn.bootcss.com/html2canvas/0.5.0-beta4/html2canvas.min.js"></script>
  <script>
    $(function () {
      var $bgm = $('#bgm')[0]; $bgm.play();

      var $loadText = $('#load-text');
      var imgArr = ['img/loading.gif'];
      preloadImage(imgArr, function (i) {
        $loadText.text(parseInt(i));
      }, function () {
        Welcome();
      });

      // 欢迎页
      function Welcome() {
        $('#main-load').fadeOut('fast');
        $('#notice').text('请点击屏幕').removeClass('hide');
        $('#welcome').fadeIn(function () {
          $('.title').addAnim('anim-title');
          $('.qingqing').addAnim('anim-left');
          $('.aolai').addAnim('anim-right');
          $('#welcome').one('tap', Word);
        });

        var r = [{
          HeadImg: 'img/head-image.jpg',
          NickName: '默认用户昵称',
        }, {}];
        r = r[Math.round(Math.random*r.length)];

        // Post('/Event/GetCustomer', {
        //     EventId: 13,
        // }, function (r) {
        //     //console.log(r);
        //     $('#user-image').attr('src', (r.HeadImg || 'img/head-image.jpg'));
        //     $('#user-name').text(r.NickName || '')
        // });
      }

      // 文字介绍页
      function Word() {
        $('#notice').addClass('hide').text('');
        $('#welcome').fadeOut('fast');
        $('#word').fadeIn(function () {
          var $item = $('.word-item');
          functionOneByOne(12, 300, function (i) {
            $item.eq(i - 1).fadeIn();
          }, function () {
            $('#notice').text('点击屏幕继续浏览').removeClass('hide');
            $('.word2').fadeIn();
          });
          setTimeout(function () {
            $('#word').one('tap', Choose);
          }, 12*300);
        });
      }

      // 选择
      var index = 0;
      function Choose() {
        $('#notice').addClass('hide').text('');
        $('#word').fadeOut('fast');
        $('#choose').fadeIn(function () {
          var $item = $('.choose-item'), $target = $('.choose-what');
          $('#notice').text('选择你今年的关键字，然后点击确认').removeClass('hide');
          functionOneByOne(20, 90, function (i) {
            $item.eq(i - 1).fadeIn();
          }, function () {
            $item.on('tap', function () {
              index = $(this).index() + 1;
              $target.removeClass().addClass('choose-what c' + index).fadeIn();
              $('#notice').addClass('hide').text('');
            });
            $('.btn-confirm').on('tap', function () {
              if (index == 0) { alert('请先选个关键字！'); return; }
              Result()
            });
          });
        });
      }

      // 选了什么字
      var itemArr = ['',
        '亲', '剁', '普', '燃', '六',
        '懵', '吃', '瘦', '撩', '闯',
        '傲', '睐', '变', '忙', '赞',
        '壕', '静', '全', '炫', '乐',
      ];
      // 字对应什么祝福语
      var itemWordArr = ['',
        ['新年辞旧岁，祝福亲爱的你，', '生活载满亲情、爱情、友情、真情！'],
        ['历经了无数次的“再XX我剁手”之后，', '如今的你变成是千手观音了吗？', '愿你身经百战炼出火眼金睛，', '新年与剁手挥别，奥莱让钱包不再哭泣。'],
        ['普天同庆的新春佳节，', '摆开规矩束缚，迈开崭新旅途！', '就是要走不寻常的道路，绽放精彩！'],
        ['愿你新年及以后，', '所走之路，皆能畅行无碍，', '所到之处，皆是春暖花开，', '新年新运，燃爆小宇宙。'],
        ['去年的你6的风生水起，', '今天的你也要再接再厉，', '在越来越6的道路上继续前行。'],

        ['去年的你，', '是否也有“当时我就懵逼了”的经历？', '新年伊始，祝你像吃了机器猫的记忆面包一般，', '和“懵”说拜拜，幸运一整年。'],
        ['愿新年给予你吃货的属性，', '也送给你土豪的身份，', '唯有美食与钞票不可辜负。'],
        ['冰冻三尺，非一日之寒', '小腹三层，非一日之馋。', '新的一年，', '就是要手握狂吃不胖符，瘦成一道闪电！'],
        ['愿新年的你，', '遇到的套路少一些，接受的真诚多一些，', '人品妥妥的爆炸，撩妹（汉）百分百成功。'],
        ['我们不常拥有新年，却常拥有新的一天，', '愿你每一年、每一天都充满着幸福与喜悦！', '愿你每一步、每一刻都承载着闯荡的勇气！'],

        ['用最炫酷的一面迎接所有挑战，', '用最高傲的姿态承包所有幸运。'],
        ['2016挥别宅，2017嗨起来，2017购起来！', '出门有福，抬头见喜，奥莱送惊喜！'],
        ['新年新改变，', '与过去say goodbye！', '2017年拥有崭新的精彩人生！'],
        ['去年的忙碌开启了今年的精彩，', '祝你在新的一年里，', '有新的开始、新的收获、', '新的快乐、新的生活。'],
        ['用“赞”填满2017，', '祝你在新的一年里好事连连，', '点“赞”不停 ！'],

        ['全新的2017年，', '你会事业正当午，金钱不胜数。', '祝你财源滚滚挡不住，钱如流水入家门！'],
        ['静如处子，动如脱兔的你，', '在全新的2017年注定不会平凡！'],
        ['奥莱愿你在新的一年里，', '十全的生活带来十美的心情，', '十全的好运带来十美的事业！'],
        ['用最炫酷的方式为新年开场，', '用最炫彩的模式挥舞人生！'],
        ['全新的一年里，', '祝你生活载满幸福，', '充满欢乐！'],
      ];
      // 结果页
      function Result() {
        // 赋值
        $('#choose-text').text(itemArr[index]);
        var _html = '';
        var item = itemWordArr[index]
        for(var i=0,len=item.length; i<len; ++i) {
          _html += '<li class="congratulate-item"><span>' + item[i] + '</span></li>';
        }
        $('#congratulate').empty().append(_html);

        // 提示生成中
        $('#rendering').removeClass('hide');

        // 显示页面
        $('#choose').fadeOut('fast');

        // 转前端实现
        $('#result, #share').fadeIn(1500, createScreenshot);
      }

      // 生成可长按保存的贺卡图片，准备重置
      function createScreenshot() {
        $('#rendering').addClass('hide');

        // var w = $('#main').width();
        // var h = $('#main').height();
        // var canvas = document.createElement("canvas");
        // canvas.width = w;
        // canvas.height = h;
        // var context = canvas.getContext("2d");
        // context.translate(-$('#main').offset().left ,0);
        // html2canvas($('#result')[0], {
        //   canvas: canvas,
        //   onrendered: function (canvas) { // 生成完成
        //     $('#rendering').addClass('hide');
        //     var strDataURI = canvas.toDataURL();
        //     $('#share-bg').attr('src', strDataURI).removeClass('hide');
            
        //       生成完成
        //       $('#rendering').addClass('hide');
        //       var strDataURI = canvas.toDataURL("image/jpeg", .4);
        //       strDataURI.replace(/^data:image\/jpeg;base64,/, '');
        //       var xx = 'data:image/jpeg;base64,';
        //       //console.log(xx);
        //       strDataURI = strDataURI.substring(xx.length);
        //       //console.log(strDataURI);

        //       // 本页内转化
        //       $('#share-bg').attr('src', strDataURI).removeClass('hide');

        //       // 本地存储
        //       //localStorage.setItem('CardImage', strDataURI);
        //       //window.location = 'result.html';

        //       // 后台存储
        //       //console.log(strDataURI);
        //       if (strDataURI) {
        //           get();
        //       } else {
        //           //setTimeout(get, 100);
        //       }

        //       function get() {
        //           Post('/Event/SaveInfo', {
        //               str: strDataURI,
        //           }, function (r) {
        //               //console.log(r);
        //               $('#share-bg').attr('src', r).removeClass('hide');
        //               //window.location = 'result.html';
        //           });
        //       }
        //   }
        // });
      }
    });
  function WxReady(apiList, callback) {
    if (typeof wx == 'undefined') {
      return console.error('没有 http://res.wx.qq.com/open/js/jweixin-1.2.0.js 文件');
    }

    if (typeof apiList == 'function') {
      callback = apiList; apiList = null;
    }

    var isReady = false;
    // 非公司域名则直接回调，如 file，localhost, github 或等情况
    if (/localhost|(192\.168)|foreverZ133/i.test(location.hostname) || !/^http/.test(location.href)) {
      return callback && callback();
    } else {
      var timer = setTimeout(function(){
        if (!isReady) {
          MAIN.game_state = 'error';
          alert('微信服务器正忙，请过会再尝试刷新');
        }
      }, 5000);
    }

    $.ajaxSetup({ async: false });
    $.getJSON("/wx/WeixinConfig", {
      Url: window.location.href
    }, function (r) {
      r.jsApiList = r.jsApiList.concat(apiList || []);
      wx.config(r);
      wx.error(function (err) {
        alert(JSON.stringify(err));
      });
      wx.ready(function () {
        isReady = true;
        callback && callback();
      });
    }, "", true);
    $.ajaxSetup({ async: true });
  }

  function WxShare(json) {
    wx.onMenuShareTimeline(json);
    wx.onMenuShareAppMessage(json);
  }

  var shareJson = {
    title: 'Happy Spring Festival 2017，一起莱！',
    desc: '手动定制2017专属高逼格贺卡，让你从群发祝福中脱颖而出！',
    icon: 'http://sum.kdcer.com/yearReport/icon.jpg',
    url: 'http://sum.kdcer.com/Event?EventId=13',
    complete: function(r) {},
  }
  WxReady(function(){
    var $bgm = $('#bgm')[0]; $bgm && $bgm.play();
    WxShare(shareJson);
  });
  </script>
</body>
</html>