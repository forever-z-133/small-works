<!DOCTYPE html>
<html class="mobile h5">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <title>桃花十里，魔镜探前世</title>
    <!--[if lt IE 9]><script>alert('您的浏览器版本过低，请更新本版本浏览器，或更换为诸如谷歌浏览器的现代浏览器')</script><![endif]-->
    <link rel="stylesheet" href="libs/style.css">
    <style>
    </style>
</head>

<body>
    <div class="rotate-info" id="info">请保持竖屏浏览</div>
    <div class="notice hide" id="notice">我的天啦</div>
    <div class="body" id="main">
        <main class="main">
            <div class="main-load" id="main-load">
                <div class="loading-img"><img src="img/icon.jpg"></div>
                <div class="loading-text"><span id="load-text">0</span>% 加载中</div>
            </div>
            <!-- 公共背景 -->
            <div class="page main-bg" id="main-bg">
                <div class="bg"><img src="img/bg-main.jpg"></div>
                <div class="logo"><a href="#"><img src="img/logo.png"></a></div>
                <div id="flower" class="bg bg-flower"></div>
            </div>
            <!--首页-->
            <div class="page welcome" id="welcome">
                <div class="title hide"><img src="img/title.png"></div>
                <div class="bg canClick"></div>
                <div class="buttons welcome-buttons">
                    <a href="#" class="btn btn-bonus"><img src="img/btn-bonus.png"></a>
                    <a href="#" class="btn btn-rule"><img src="img/btn-rule.png"></a>
                </div>
            </div>
            <!-- 规则页 -->
            <div class="page rule" id="rule">
                <div class="bg alert-bg"></div>
                <div class="bg-rule">
                    <img src="img/bg-rule.png">
                    <a href="#" class="btn btn-close"><img src="img/btn-close.png"></a>
                </div>
            </div>
            <!-- 墨镜页 -->
            <div class="page mirror" id="mirror">
                <div class="bg"><img src="img/bg-mirror.jpg"></div>
                <canvas id="gua" class="bg full"></canvas>
                <div class="cloud">
                    <div class="cloud1 hide"><img src="img/cloud1.png"></div>
                    <div class="cloud2 hide"><img src="img/cloud2.png"></div>
                    <div class="cloud3 hide"><img src="img/cloud3.png"></div>
                    <div class="cloud4 hide"><img src="img/cloud4.png"></div>
                    <div class="cloud5 hide"><img src="img/cloud.png"></div>
                </div>
            </div>
            <!-- 人物页 -->
            <div class="page member" id="member">
                <div class="bg"><img src="img/bg-member.jpg"></div>
                <div class="member member1">
                    <div class="pic"><img src="img/menber3.png"></div>
                    <div class="word w1">灼灼桃花十里，</div>
                    <div class="word w2">取一朵放在心上，足矣。</div>
                </div>
                <div class="member member2">
                    <div class="pic"><img src="img/menber4.png"></div>
                    <div class="word">情不知所起，一往而深。</div>
                </div>
                <div class="member member3">
                    <div class="pic"><img src="img/menber2.png"></div>
                    <div class="word w1">始是相逢疑梦中，</div>
                    <div class="word w2">情深情浅错缘生。</div>
                </div>
                <div class="member member4">
                    <div class="pic"><img src="img/menber1.png"></div>
                    <div class="word">温善方如始终。</div>
                </div>
                <div class="bg"><img src="img/bg-menber-cover.png"></div>
                <a href="#" class="btn btn-go hide"><img src="img/btn-go.png"></a>
                <div class="top-bar">
                    <a href="#" class="btn btn-back"><img src="img/btn-back.png"></a>
                    <a href="#" class="btn btn-share"><img src="img/btn-share.png"></a>
                </div>
            </div>
            <!-- 场景页 -->
            <div class="page screen" id="screen">
                <div class="screen screen1 bg">
                    <img src="img/bg-screen2.jpg">
                    <div class="finger"><span></span></div>
                </div>
                <div class="screen screen2 bg">
                    <img src="img/bg-screen1.jpg">
                    <div class="finger"><span></span></div>
                </div>
            </div>
            <!-- 画符页 -->
            <div class="page symbol" id="symbol">
                <div class="bg alert-bg"></div>
                <div class="bg bg-symbol"><img src="img/bg-symbol.png"></div>
                <canvas id="draw" class="bg full"></canvas>
            </div>
            <!-- 抽奖中 -->
            <div class="page number" id="number">
                <div class="bg alert-bg"></div>
                <div class="timecount" id="wait">0</div>
            </div>
            <!-- 中奖页 -->
            <div class="page prize-good" id="prize-good">
                <div class="bg alert-bg"></div>
                <div class="bg"><img src="img/bg-good.png"></div>
                <div class="panel good-panel">
                    <div class="w1">恭喜你!</div>
                    <div class="w2">获得<span id="prize-name">“伊人”节礼物一份</span></div>
                    <div class="qrcode">
                        <img src="img/qrcode.png" id="qrcode">
                        <div class="hasGot hide" id="hasGot"><img src="img/hasGot.png"></div>
                    </div>
                    <div class="w3">请于2017年3月4日、3月5日、3月8日下午13:00-18:00至商场1F2枚魔镜展示处兑换奖品。</div>
                </div>
                <div class="top-bar">
                    <a href="#" class="btn btn-back"><img src="img/btn-back.png"></a>
                    <a href="#" class="btn btn-share"><img src="img/btn-share.png"></a>
                </div>
            </div>
            <!-- 未中奖页 -->
            <div class="page prize-bad" id="prize-bad">
                <div class="bg alert-bg"></div>
                <div class="bg"><img src="img/bg-bad.png"></div>
                <div class="bg bad-word"><img src="img/bad-word.png"></div>
            </div>
            <!-- 分享页 -->
            <div class="page share" id="share">
                <div class="bg bg-white"></div>
                <div class="bg-share"><img src="img/bg-share.png" /></div>
            </div>
        </main>
        <div class="others">
            <audio src="img/bgm.mp3" id="bgm" preload autoplay hidden></audio>
        </div>
    </div>
    <script src="libs/common.js"></script>
    <script src="libs/guaguale.js"></script>
    <script src="libs/flowerfall.js"></script>
    <script src="libs/drawsymbol.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script>
        $(function () {

            /**
             * 基础
             ***************************************/
            WxShare();
            var $notice = $('#notice');
            var $bgm = $('#bgm')[0]; $bgm.play();
            $('body').on('tap', '.btn-share', function () {
                $('#share').fadeIn().off().on('tap', function () {
                    $(this).fadeOut('fast');
                });
            });

            /**
             * 预加载
             ***************************************/
            var $loadText = $('#load-text');
            var imgArr = ['img/bad-word.png', 'img/bg-bad.png', 'img/bg-good.png', 'img/bg-main.jpg', 'img/bg-member.jpg', 'img/bg-menber-cover.png', 'img/bg-mirror.jpg', 'img/bg-rule.png', 'img/bg-screen1.jpg', 'img/bg-screen2.jpg', 'img/bg-symbol.png', 'img/btn-bonus.png', 'img/btn-close.png', 'img/btn-go.png', 'img/btn-rule.png', 'img/cloud.png', 'img/cloud1.png', 'img/cloud2.png', 'img/cloud3.png', 'img/cloud4.png', 'img/hasGot.png', 'img/logo.png', 'img/menber1.png', 'img/menber2.png', 'img/menber3.png', 'img/menber4.png', 'img/title.png', 'img/word-none.png', 'img/word-one.png'];
            preloadImage(imgArr, function (per) {
                $loadText.text(parseInt(per));
            }, function () {
                Init();
            });

            /**
             * 入口判断
             ***************************************/
            function Init() {
                // 主背景
                $('#main-load').fadeOut('fast');
                $('#main-bg').fadeIn();
                $('#flower').snowfall('clear');
                $('#flower').snowfall({
                    image: "img/huaban.png",
                    flakeCount: 10,
                    minSize: 8,
                    maxSize: 22,
                    flakeIndex: 2,
                });

                Welcome(true);


                // $('#main-load').fadeOut('fast');
                // Post('/Event/PrevLifeEnter', {
                //     EventId: 20,
                // }, function (r) {
                //     // 主背景
                //     $('#main-bg').fadeIn();
                //     $('#flower').snowfall('clear');
                //     $('#flower').snowfall({
                //         image: "img/huaban.png",
                //         flakeCount: 10,
                //         minSize: 8,
                //         maxSize: 22,
                //         flakeIndex: 2,
                //     });

                //     // 逻辑判断
                //     console.log(r);
                //     if (!r.State) { // 不能抽
                //         if (r.ErrorMesage) { alert(r.ErrorMesage); return; } // 非法
                //         Welcome();
                //         if (r.Bonus) {   // 已中奖
                //             $('#qrcode').attr('src', r.Bonus);
                //             $('#prize-name').text(r.Des);
                //             if (r.Take) { // 已兑换
                //                 $('#hasGot').removeClass('hide');
                //             }
                //         } else {
                //             $('.btn-bonus').disable().find('img').addClass('grey');
                //         }
                //     } else {    // 能抽
                //         Welcome(true);
                //         $('.btn-bonus').disable().find('img').addClass('grey');
                //     }
                // });
            }

            /**
             * 首页
             ***************************************/
            function Welcome(canPlay) {
                $('#welcome').fadeIn(function () {
                    $('.title').addAnim('anim-title', function () {
                        $('.welcome-buttons').fadeIn('fast');
                        $('.btn-bonus').on('tap', function () { Good(); });
                        $('.btn-rule').on('tap', Rule);
                        if (canPlay) {
                            $('#welcome > .canClick').on('tap', Mirror);
                            $notice.text('点击屏幕开始前世之旅').removeClass('hide');
                        }
                    }, true);
                });
            }

            /**
             * 规则页
             ***************************************/
            function Rule() {
                $('#rule').fadeIn();
                $('.btn-close').off().on('tap', function () {
                    $('#rule').fadeOut('fast');
                });
            }

            /**
             * 魔镜页
             ***************************************/
            var gua = GuaGuaLe('#gua', {
                front: 'img/cloud.png',
                size: 40,
            });
            function Mirror() {
                // 初始化
                $('#member, #welcome').fadeOut('fast');
                $('.cloud1, .cloud2, .cloud3, .cloud4').removeClass('anim-cloud');
                $notice.text('').addClass('hide');
                gua.clear();
                // 正式运行
                $('#mirror').fadeIn(function () {
                    $('.cloud').show(0);
                    $('.cloud1').addAnim('anim-cloud', null, true);
                    $('.cloud2').addAnim('anim-cloud', null, true);
                    $('.cloud3').addAnim('anim-cloud', null, true);
                    $('.cloud4').addAnim('anim-cloud', function () {
                        $('.cloud').fadeOut();
                        $notice.text('擦除云雾，查看我的三生三世').removeClass('hide');
                        gua.init(function () {
                            $notice.text('').addClass('hide');
                            var rmd = Math.ceil(Math.random() * 4);
                            Member(rmd);
                        });
                    }, false);
                });
            }

            /**
             * 人物页
             ***************************************/
            function Member(num) {
                // 初始化
                $('.member').hide(0).removeClass('anim-member');
                $('.btn-go').addClass('hide');
                $('.btn-back').off();
                // 正式运行
                $('#mirror').fadeOut('fast');
                $('#member').fadeIn(function () {
                    var $this = $('.member' + num)
                    var $obj = $this.find('.word');
                    $obj.each(function () {
                        if ($(this).find('span').length > 0) {
                        	$(this).find('span').addClass('hide');
                        	return;
                        }
                        var _html = '', t = $(this).text();
                        for (var i = 0, len = t.length; i < len; i++) {
                            _html += '<span class="hide">' + t[i] + '</span>';
                        }
                        $(this).html(_html);
                    });
                    $this.addAnim('anim-member', function () {
                        var $word = $obj.find('span').removeClass('anim-word');
                        functionOneByOne($word.length, 200, function (i) {
                            $word.eq(i-1).addAnim('anim-word');
                        }, function () {
                            $('.btn-go').removeClass('hide');
                            $('.btn-back').on('touchstart', Mirror);
                            $('.btn-go').off().on('tap', function () {
                                var target = [null, 1, 2, 1, 1];
                                Screen(target[num]);
                            });
                        });
                    });
                });
                WxShare(num);
            }

            /**
             * 场景页
             ***************************************/
            function Screen(num) {
                $('#screen').find('.screen' + num).show(0);
                $('#screen').fadeIn(function () {
                    $('#member').fadeOut('fast');
                    $notice.text('点击亮点，记忆就在那里').removeClass('hide');
                    $('.finger').off().on('tap', Symbol);
                });
            }

            /**
             * 画符抽奖页
             ***************************************/
            function Symbol() {
                $('#symbol').fadeIn(function () {
                    var draw = DrawSymbol('#draw', {
                        size: 20,
                        color: '#fff',
                        complete: Prize,
                    });
                    draw.init();
                    $notice.html('<span class="white">绘制符文，解开封印</span>').removeClass('hide');
                });
            }

            /**
             * 抽奖逻辑
             ***************************************/
            function Prize() {
                $notice.html('').addClass('hide');
                $('#number').fadeIn();
                $('#symbol, #screen').fadeOut('fast');
                $('#wait').text(3).addAnim('anim-num', function () {
                    $('#wait').text(2).addAnim('anim-num', function () {
                        $('#wait').text(1).addAnim('anim-num', function () {
                            $('#wait').text('准备奖品中...');
                            GetPrize();
                        }, true);
                    }, false);
                }, false);

                function GetPrize() {
                	$('#number').fadeOut('fast');
                	var get = Math.random() > 0.5;
                	if (get) Good(true);
                	else Bad();

                	
                    // Post('/Event/PrevLifeLotteryBehavior', {
                    //     eventId: 20,
                    // }, function (r) {
                    //     console.log(r);
                    //     $('#number').fadeOut('fast');
                    //     if (r.State) {
                    //         if (r.Bonuses.length > 0) {
                    //             $('#qrcode').attr('src', r.Bonuses[0].QRCode);
                    //             $('#prize-name').text(r.Bonuses[0].Name);
                    //             Good(true);
                    //         } else { alert('错误!') };
                    //     } else {
                    //         Bad();
                    //         //if (r.ErrorMesage) alert(r.ErrorMesage);
                    //     }
                    // });
                }
            }

            /**
             * 中奖页
             ***************************************/
            function Good(prize) {
                $notice.text('').addClass('hide');
                var $obj = $('#prize-good').fadeIn();
                if (prize) {
                    $obj.find('.btn-back').hide(0);
                } else {
                    $obj.find('.btn-back').show(0).off().on('tap', function () {
                        $obj.fadeOut('fast');
                    });
                }
            }

            /**
             * 未中奖页
             ***************************************/
            function Bad() {
                $('#prize-bad').fadeIn();
            }
        });

        function WxShare(type) {
            var _word = '', _music = false;
            switch (type) {
                case 1: _word = '老身前世竟是青丘白浅，一起来看看自己的前世是谁吧！'; _music = false; break;
                case 2: _word = '前世竟是凤九殿下，真真是太可爱了，也来看看自己的前世是谁吧！'; _music = false; break;
                case 3: _word = '前世竟是如此深情的素锦，你也来看看前世是谁吧！'; _music = false; break;
                case 4: _word = '魔镜说我的前世是胭脂，你也来看看！'; _music = false; break;
                default: _word = '惊！前世竟然浮现，一起来看看自己的前世吧！'; _music = true; break;
            }
            WeChat('桃花十里，魔镜探前世', _word, 'http://sum.kdcer.com/PrevLife/img/icon.jpg', 'http://sum.kdcer.com/Event?EventId=20', _music);
        }
    </script>
</body>
</html>